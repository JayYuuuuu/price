<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>到手价与标价建议｜保本引擎</title>
  <style>
    :root{
      --bg:#F5F5F7; --card:#FFFFFF; --ink:#111111; --muted:#6e6e73; --accent:#007aff;
      --ok:#34c759; --warn:#ff9f0a; --bad:#ff3b30; --radius:14px;
      --sans:-apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      --mono:-apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:var(--sans)}
    header{padding:20px}
    h1{margin:0; font-size:22px}
    .sub{color:var(--muted); font-size:13px; margin-top:6px}
    main{padding:20px; display:grid; gap:16px}

    /* 两栏：左输入、右结果 */
    .wrap{display:grid; grid-template-columns: 45% 54%; gap:16px; align-items:stretch}
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } }

    .card{background:var(--card); border:1px solid #d2d2d7; border-radius:var(--radius); box-shadow:0 1px 2px rgba(0,0,0,.06); display:flex; flex-direction:column; height:100%}
    .card h2{margin:0; font-size:18px; padding:14px 14px; border-bottom:1px solid #e5e5ea; background:linear-gradient(180deg,#fafafa,#fff)}
    .content{padding:14px; flex:1; display:block}

    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px 2px}
    input, select{width:100%; background:#fff; border:1px solid #d2d2d7; border-radius:12px; padding:12px 10px; font-size:22px; font-weight:700; outline:none}
    input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,122,255,.18)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid-3565{grid-template-columns:35% 64%}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }

    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#eef2f7; border:1px solid #cfd3da; font-size:12px; font-weight:600; color:#0f172a; letter-spacing:.2px}

    /* 结果大字 */
    .big{display:block; width:100%; text-align:center; padding:18px 14px; border-radius:14px; box-sizing:border-box}
    .big-input{width:100%; background:linear-gradient(180deg,#fafafa,#fff); border:1px solid #e5e5ea; border-radius:14px; padding:18px 16px; font-size:46px; font-weight:800; text-align:center; outline:none}
    .big-input.primary{--base:40px; font-size:var(--base); border-color:#d0e3ff; box-shadow:0 0 0 3px rgba(0,122,255,.10)}
    .big-input.secondary{font-size:35px}
    .big-input.tertiary{font-size:40px}
    .big-input[readonly]{background:linear-gradient(180deg,#fafafa,#fff)}
    .big-input.asdiv{display:flex; align-items:baseline; justify-content:center; gap:10px}
    .big-input .minor{font-weight:700; color:#444; font-size:calc(var(--base, 46px) - 8px)}
    .big-input .prefix,.big-input .suffix{font-weight:700; color:#333; font-size:calc(var(--base, 40px) - 10px)}
    .big-input.primary .amount{
      background: linear-gradient(180deg,#0062cc,#007aff);
      color: #ffffff;
      border-radius: 12px;
      padding: 0 8px;
      box-shadow: 0 0 0 1px rgba(255,255,255,.15);
    }
    .big-input .amount{font-size:calc(var(--base, 40px) + 6px); font-weight:900; color:#111; letter-spacing:.5px}
    .big.hint{font-size:13px; color:var(--muted); padding:0; margin-top:6px; display:none}
    .muted{color:var(--muted)}
    .step{font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.2px}

    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    .kpi .item{border:1px solid #e5e5ea; border-radius:12px; background:#fff; padding:10px}
    .kpi .lab{font-size:12px; color:var(--muted)}
    .kpi .val{margin-top:4px; font-size:18px; font-weight:500; font-family:var(--mono);color: #444444;}

    .note{font-size:12px; color:var(--muted)}
    
    /* 低调的清除按钮样式 */
    .clear-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .clear-btn:hover {
      background: rgba(0,0,0,0.05);
      color: var(--bad);
    }

    /* ===== 目标利润率选择器样式 ===== */
    .margin-selector {
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      border: 2px solid #e1e5f2;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 20px rgba(0, 122, 255, 0.08);
    }
    
    .margin-label {
      display: block;
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 16px;
      text-align: center;
      letter-spacing: 0.5px;
    }
    
    .margin-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .margin-option {
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .margin-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .option-content {
      background: #ffffff;
      border: 2px solid #e5e5ea;
      border-radius: 14px;
      padding: 20px 16px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .margin-option input[type="radio"]:checked + .option-content {
      border-color: var(--accent);
      background: linear-gradient(135deg, #f0f7ff 0%, #ffffff 100%);
      box-shadow: 0 4px 20px rgba(0, 122, 255, 0.15);
      transform: translateY(-2px);
    }
    
    .margin-option:hover .option-content {
      border-color: #007aff;
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.1);
    }
    
    .option-value {
      font-size: 38px;
      font-weight: 900;
      color: var(--accent);
      margin-bottom: 8px;
      letter-spacing: 1px;
    }
    
    .option-desc {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }
    
    .margin-option input[type="radio"]:checked + .option-content .option-value {
      color: var(--accent);
    }
    
    .margin-option input[type="radio"]:checked + .option-content .option-desc {
      color: #007aff;
      font-weight: 600;
    }

    /* iPad 适配 */
    @media (max-width: 1100px){
      input, select{font-size:20px}
    }
    /* 手机端优化（<=740px） */
    @media (max-width: 740px){
      header{padding:16px}
      h1{font-size:18px}
      .sub{font-size:12px}
      main{padding:16px; gap:12px}
      .wrap{gap:12px}
      label{font-size:11px}
      input, select{font-size:16px; padding:10px 9px}
      .big-input{font-size:22px; padding:14px 12px}
      .big-input.primary{--base:30px}
      .big-input.secondary{font-size:26px}
      .big-input.tertiary{font-size:24px}
      .big-input .prefix,.big-input .suffix{font-size:calc(var(--base, 30px) - 10px)}
      .big-input .amount{font-size:calc(var(--base, 30px) + 6px)}
      .big-input .minor{font-size:calc(var(--base, 30px) - 8px)}
      
      /* 手机端到手价输入框多行布局 */
      .big-input.asdiv {
        flex-direction: column;
        align-items: center;
        gap: 5px;
        padding: 10px;
      }
      .big-input .prefix {
        display: block;
        white-space: nowrap;
        font-size: 15px;
        font-weight: 600;
        margin-bottom: -2px;
      }
      .big-input .amount {
        display: block;
        font-size: 36px;
        line-height: 1.1;
        padding: 2px 12px;
      }
      .big-input .suffix {
        display: block;
        white-space: nowrap;
        font-size: 15px;
        font-weight: 600;
        margin-top: -2px;
      }
      .big-input .minor {
        display: block;
        font-size: 12px;
        margin-top: 2px;
      }

      /* 移动端利润率选择器适配 - 保持两列布局 */
      .margin-selector { padding: 14px; margin: 12px 0 }
      /* 移除单列设置，保持两列布局 */
      /* .margin-options { grid-template-columns: 1fr; gap: 10px } */
      .option-content { padding: 10px 8px }
      .option-value { font-size: 24px }
      .margin-label { font-size: 14px; margin-bottom: 10px }

      /* 系统参数保持一行4列布局（按需求） */
      .kpi { grid-template-columns: repeat(4, 1fr); gap: 8px }
      .kpi .item { padding: 8px 6px }
      .kpi .lab { font-size: 11px; line-height: 1.2 }
      .kpi .val { font-size: 13px; margin-top: 2px }
    }
  </style>
</head>
<body>
  <header>
    <h1>恒源祥售价计算（税务合规版）</h1>
    <div class="sub">已知成本与系统参数 → 推算合理到手价 → 建议价（.8 结尾）→ 页面标价（默认立减10%）</div>
  </header>

  <main>
    <div class="wrap">
      <!-- 左：输入与固定参数展示 -->
      <section class="card">
        <h2>参数与输入 <button class="clear-btn" id="clearBtn" title="清除所有保存的输入数据">恢复默认</button></h2>
        <div class="content">
          <div class="grid grid-3565">
            <div>
              <label>聚水潭进货价（不含税，¥）</label>
              <input id="costPrice" type="text" placeholder="35.00" inputmode="decimal" pattern="^\d+(\.\d{1,2})?$" autocomplete="off" />
            </div>
            <div>
              <label>产品品类（预估退货率与广告占比）</label>
              <select id="cate">
                <option value="" selected>请选择品类</option>
                <option value="内裤|0.06|0.30">内裤（退货率 6%）</option>
                <option value="薄内衣|0.12|0.22">薄内衣（退货率预估 12%）</option>
                <option value="夹棉空气层|0.25|0.23">夹棉空气层（退货率预估 25%）</option>
                <option value="加绒内衣|0.18|0.20">加绒内衣（退货率预估 20%）</option>
                <option value="家居服|0.22|0.15">家居服（退货率预估 20%）</option>
                <option value="校服神器|0.20|0.20">校服神器（退货率预估 20%）</option>
                <option value="薄马甲|0.15|0.18">薄马甲（退货率预估 15%）</option>
                <option value="羊毛衫|0.22|0.08">羊毛衫（退货率预估 22%）</option>
              </select>
            </div>
          </div>

          <div class="margin-selector" style="margin-top:16px">
            <label class="margin-label">🎯 目标利润率</label>
            <div class="margin-options">
              <label class="margin-option">
                <input type="radio" name="targetM" value="0.05" checked />
                <div class="option-content">
                  <div class="option-value">5%</div>
                  <div class="option-desc">保守策略</div>
                </div>
              </label>
              <label class="margin-option">
                <input type="radio" name="targetM" value="0.08" />
                <div class="option-content">
                  <div class="option-value">8%</div>
                  <div class="option-desc">平衡策略</div>
                </div>
              </label>
            </div>
          </div>

          <div class="block" style="margin-top:12px">
            <div class="note">系统默认参数 | 均以含税价为口径（不可修改，用于参与计算）：</div>
            <div class="kpi" style="margin-top:8px">
              <div class="item"><div class="lab">销项税率</div><div class="val" id="k_sales">13%</div></div>
              <div class="item"><div class="lab">商品进项税率</div><div class="val" id="k_output">13%</div></div>
              <div class="item"><div class="lab">开票成本比例</div><div class="val" id="k_input">6%</div></div>
              <div class="item"><div class="lab">服务费税率（佣金/广告）</div><div class="val" id="k_svat">6%</div></div>
              <div class="item"><div class="lab">平台佣金率</div><div class="val" id="k_comm">5.5%</div></div>
              <div class="item"><div class="lab">物流费</div><div class="val" id="k_ship">¥2.80</div></div>
              <div class="item"><div class="lab">运费险</div><div class="val" id="k_ins">¥1.50</div></div>
              <div class="item"><div class="lab">其他成本</div><div class="val" id="k_other">¥2.50</div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 右：计算结果 -->
      <section class="card">
        <h2>结果与建议（价格已包含广告费预算）</h2>
        <div class="content">
          <!-- 1. 推算到手价（来源） -->
          <div>
            <label>到手价</label>
            <div id="outPriceInput" class="big-input tertiary asdiv">
              <span class="prefix">推算到手价</span>
              <span id="outAmount" class="amount">—</span>
              <span class="suffix">元可达目标</span>
              <span id="outMinor" class="minor"></span>
            </div>
          </div>

          <!-- 2. 建议到手价（主结论） -->
          <div style="margin-top:14px">
            <label>建议到手价</label>
            <div id="sugPriceInput" class="big-input primary asdiv">
              <span class="prefix">建议到手价</span>
              <span id="sugAmount" class="amount">—</span>
              <span class="suffix">元</span>
              <span id="sugMinor" class="minor"></span>
            </div>
          </div>

          <!-- 3. 页面标价（基于优惠反解） -->
          <div style="margin-top:14px">
            <label>页面标价（店铺优惠立减10%）</label>
            <div id="listPriceInput" class="big-input secondary asdiv">
              <span class="prefix">页面标价</span>
              <span id="listAmount" class="amount">—</span>
              <span class="suffix">元（立减10%）</span>
              <span id="listMinor" class="minor"></span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ===== 计算函数（从 engine.js 精简内联，支持离线独立运行） =====
    function profitGivenAdRateAndR(p, adRate, r, basis) {
      const Rev = p.sellingPrice * r;
      const goodsCost = p.costPrice * (1 + p.inputTaxRate) * (p.goodsMode === 'canReturn' ? r : 1);
      const othersCost = p.shippingCost + p.shippingInsurance + p.otherCost;
      const commission = p.sellingPrice * p.platformRate * r;

      const VAT_out = Rev / (1 + p.salesTaxRate) * p.salesTaxRate;
      const VAT_in_goods = p.costPrice * p.outputTaxRate * (p.goodsMode === 'canReturn' ? r : 1);
      const VAT_in_comm = commission / (1 + p.serviceVATRate) * p.serviceVATRate;

      const base = (basis === 'gmv') ? p.sellingPrice : Rev;
      const adCostGiven = base * adRate;
      const VAT_in_ad_given = adCostGiven / (1 + p.serviceVATRate) * p.serviceVATRate;

      const profit = Rev - (goodsCost + othersCost + commission + adCostGiven)
        - (VAT_out - VAT_in_goods - VAT_in_comm - VAT_in_ad_given);
      const margin = (Rev > 0) ? (profit / Rev) : NaN;
      return { profit, margin, adCostGiven };
    }

    function solveSellingPrice(p, r, a, basis, m) {
      const G = p.costPrice * (1 + p.inputTaxRate) * (p.goodsMode === 'canReturn' ? r : 1);
      const O = p.shippingCost + p.shippingInsurance + p.otherCost;
      const Vg = p.costPrice * p.outputTaxRate * (p.goodsMode === 'canReturn' ? r : 1);
      const t = p.salesTaxRate;
      const s = p.serviceVATRate;
      const pr = p.platformRate;

      const numerator = (Vg - G - O);
      let denom;

      if (basis === 'effective') {
        // S = (Vg - G - O) / [ r * ( m - 1 + t/(1+t) + (a+pr)/(1+s) ) ]
        denom = r * (m - 1 + (t/(1+t)) + ((a + pr) / (1 + s)));
      } else {
        // S = (Vg - G - O) / [ r * ( m - 1 + t/(1+t) + pr/(1+s) ) + a/(1+s) ]
        denom = r * (m - 1 + (t/(1+t)) + (pr / (1 + s))) + (a / (1 + s));
      }
      if (!isFinite(numerator) || !isFinite(denom) || Math.abs(denom) < 1e-9) return NaN;
      const S = numerator / denom;
      return S > 0 && isFinite(S) ? S : NaN;
    }

    // ===== 标价计算（到手价 ↔ 标价）辅助 =====
    function yuanToWu(y){
      const s = String(y ?? '').trim();
      if (!s) return 0;
      const m = s.match(/^(-?)(\d+)(?:\.(\d{0,}))?$/);
      if (!m) return Math.round(Number(s) * 10000);
      const sign = m[1] === '-' ? -1 : 1;
      const int = m[2];
      const dec = (m[3] || '').padEnd(4, '0').slice(0, 4);
      return sign * (parseInt(int, 10) * 10000 + parseInt(dec || '0', 10));
    }
    function listPriceForwardNetCents(listPriceCents, discountPct, tiers){
      const priceWu = Math.floor(Number(listPriceCents) * 100);
      const factor = Math.round((1 - Number(discountPct || 0)) * 10000);
      let afterWu = Math.floor(priceWu * factor / 10000);
      let offWu = 0;
      if (Array.isArray(tiers)){
        for (const t of tiers){
          const thrWu = yuanToWu(t?.threshold ?? '0');
          const offTWu = yuanToWu(t?.off ?? '0');
          if (afterWu >= thrWu) offWu = Math.max(offWu, offTWu);
        }
      }
      const netWu = Math.max(0, afterWu - offWu);
      return Math.floor(netWu / 100);
    }
    function listPriceForwardNetWu(listPriceCents, discountPct, tiers){
      const priceWu = Math.floor(Number(listPriceCents) * 100);
      const factor = Math.round((1 - Number(discountPct || 0)) * 10000);
      let afterWu = Math.floor(priceWu * factor / 10000);
      let offWu = 0;
      if (Array.isArray(tiers)){
        for (const t of tiers){
          const thrWu = yuanToWu(t?.threshold ?? '0');
          const offTWu = yuanToWu(t?.off ?? '0');
          if (afterWu >= thrWu) offWu = Math.max(offWu, offTWu);
        }
      }
      return Math.max(0, afterWu - offWu);
    }
    function solveListPriceCents(targetCents, discountPct, tiers){
      if (!(targetCents > 0)) return 0;
      let lo = targetCents;
      let hi = Math.max(targetCents + 1, targetCents * 2 + 1000);
      while (listPriceForwardNetCents(hi, discountPct, tiers) < targetCents){
        hi = Math.floor(hi * 1.5) + 1000;
        if (hi > 1e9) break;
      }
      while (lo < hi){
        const mid = Math.floor((lo + hi) >> 1);
        const net = listPriceForwardNetCents(mid, discountPct, tiers);
        if (net >= targetCents) hi = mid; else lo = mid + 1;
      }
      let price = lo;
      const targetWu = targetCents * 100;
      let netAfterWu = listPriceForwardNetWu(price, discountPct, tiers);
      while (price > 0 && netAfterWu > targetWu){
        price -= 1;
        netAfterWu = listPriceForwardNetWu(price, discountPct, tiers);
      }
      return price;
    }

    // 固定系统参数（不可编辑）
    const SYSTEM = {
      salesTaxRate: 0.13,       // 销项税率 13%
      outputTaxRate: 0.13,      // 商品进项税率 13%
      inputTaxRate: 0.06,       // 开票成本比例 6%
      serviceVATRate: 0.06,     // 服务费税率（佣金/广告）6%
      platformRate: 0.055,      // 平台佣金率 5.5%
      shippingCost: 2.8,
      shippingInsurance: 1.5,
      otherCost: 2.5,
      goodsMode: 'canReturn'
    };

    const $ = id => document.getElementById(id);
    const fmt2 = n => (isFinite(n) ? Number(n).toFixed(2) : '—');
    const fmtPct = n => (isFinite(n) ? (n*100).toFixed(2) + '%' : '—');

    const inCost = $('costPrice');
    const selCate = $('cate');
    const outPriceInput = $('outPriceInput');
    const outAmount = $('outAmount');
    const outMinor = $('outMinor');
    const sugPriceInput = $('sugPriceInput');
    const sugAmount = $('sugAmount');
    const sugMinor = $('sugMinor');
    const listPriceInput = $('listPriceInput');
    const listAmount = $('listAmount');
    const listMinor = $('listMinor');

    function parseCate(val){
      // 格式： 名称|退货率|广告占比
      const parts = String(val || '').split('|');
      const name = parts[0] || '';
      const rr = parseFloat(parts[1] || '0') || 0; // 小数
      let a = parseFloat(parts[2] || '0') || 0; // 小数（广告占比数值）
      
      // 新算法：针对内裤类目的广告占比动态调整
      // 当内裤类目的进货价小于32.5元时，广告占比按30%预估
      // 当进货价大于等于32.5元时，广告占比按25%预估
      const costPrice = parseFloat(inCost.value) || 0;
      if (name === '内裤') {
        if (costPrice >= 32.5) {
          a = 0.25; // 进货价>=32.5元时，内裤广告占比为25%
        }
        // 小于32.5元时保持原有的30%（无需修改）
      }
      
      return { name, returnRate: rr, adRate: a };
    }

    function toCents(x){ return Math.round(Number(x || 0) * 100); }
    function fromCents(c){ return Number(c || 0) / 100; }

    function roundUpTo_5_8_9_8(x){
      // 规则：向上取到以 .8 结尾的 5 或 9 位，如 65.8、69.8
      // 新规则：如果推算的到手价便宜1元以内有最佳售价，则可以选择往下一档的售价
      const base10 = Math.floor(x / 10) * 10;
      const c58 = base10 + 5.8;
      const c98 = base10 + 9.8;
      const prevBase98 = base10 - 10 + 9.8; // 上一档的9.8
      const prevBase58 = base10 - 10 + 5.8; // 上一档的5.8
      const nextBase58 = base10 + 10 + 5.8;
      
      // 如果价格刚好比某个档位高一点点（不超过1元），则选择往下一档
      if (x > c58 && x <= c58 + 1) return c58;
      if (x > c98 && x <= c98 + 1) return c98;
      
      // 新增：如果价格比某个档位低一点点（不超过1元），则选择往上一档
      if (x < c58 && x >= c58 - 1) return c58;
      if (x < c98 && x >= c98 - 1) return c98;
      
      // 检查上一档的价格，但必须在1元范围内
      if (x >= prevBase98 && x <= prevBase98 + 1 && prevBase98 > 0) return prevBase98;
      if (x >= prevBase58 && x <= prevBase58 + 1 && prevBase58 > 0) return prevBase58;
      
      // 原有逻辑：选择合适的档位
      if (x <= c58) return c58;
      if (x <= c98) return c98;
      return nextBase58; // 下一档 5.8
    }

    function recalc(){
      const cost = parseFloat(inCost.value);
      const cateVal = (selCate.value || '').trim();
      if (!cateVal){
        if (outAmount) outAmount.textContent = '—';
        if (outMinor) outMinor.textContent = '';
        if (sugAmount) sugAmount.textContent = '—';
        if (sugMinor) sugMinor.textContent = '（请先选择品类再计算）';
        if (listAmount) listAmount.textContent = '—';
        if (listMinor) listMinor.textContent = '';
        return;
      }
      const cate = parseCate(cateVal);
      const targetM = parseFloat((document.querySelector('input[name="targetM"]:checked')||{}).value || '0.08');

      if (!(cost > 0)){
        if (outAmount) outAmount.textContent = '—';
        if (outMinor) outMinor.textContent = '';
        if (sugAmount) sugAmount.textContent = '—';
        if (sugMinor) sugMinor.textContent = '';
        if (listAmount) listAmount.textContent = '—';
        if (listMinor) listMinor.textContent = '';
        return;
      }

      const r = Math.max(0, 1 - cate.returnRate);

      // 构造参数：售价未知，仅用于公式中的成本项
      const baseParams = {
        sellingPrice: 0, // solveSellingPrice 不依赖该值
        returnRate: cate.returnRate,
        costPrice: cost,
        inputTaxRate: SYSTEM.inputTaxRate,
        outputTaxRate: SYSTEM.outputTaxRate,
        platformRate: SYSTEM.platformRate,
        shippingCost: SYSTEM.shippingCost,
        shippingInsurance: SYSTEM.shippingInsurance,
        otherCost: SYSTEM.otherCost,
        salesTaxRate: SYSTEM.salesTaxRate,
        serviceVATRate: SYSTEM.serviceVATRate,
        goodsMode: SYSTEM.goodsMode
      };

      // 到手价：按广告占比（有效营收口径）与目标利润率反解
      const S = solveSellingPrice(baseParams, r, cate.adRate, 'effective', targetM);
      if (outAmount) outAmount.textContent = isFinite(S)&&S>0?fmt2(S):'—';
      if (outMinor) outMinor.textContent = '';

      // 建议到手价：向上取到 *.8（优先 9.8，其次 5.8）
      let S_sug = isFinite(S) && S>0 ? roundUpTo_5_8_9_8(S) : NaN;
      if (!isFinite(S_sug)){
        if (sugAmount) sugAmount.textContent = '—';
        if (sugMinor) sugMinor.textContent = '';
      } else {
        // 计算建议价对应的利润率
        const paramsForMargin = { ...baseParams, sellingPrice: S_sug };
        const { margin } = profitGivenAdRateAndR(paramsForMargin, cate.adRate, r, 'effective');
        if (sugAmount) sugAmount.textContent = `${fmt2(S_sug)}`;
        if (sugMinor) sugMinor.textContent = `（利润率约 ${fmtPct(margin)}）`;
      }

      // 页面标价：默认立减10%、无满减
      if (isFinite(S_sug)){
        const targetCents = toCents(S_sug);
        const listCents = solveListPriceCents(targetCents, 0.10, []);
        const listY = fromCents(listCents);
        const checkNet = fromCents(listPriceForwardNetCents(listCents, 0.10, []));
        if (listAmount) listAmount.textContent = fmt2(listY);
        if (listMinor) listMinor.textContent = '';
      } else {
        if (listAmount) listAmount.textContent = '—';
        if (listMinor) listMinor.textContent = '';
      }
    }

    // ===== 本地存储功能 =====
    const STORAGE_KEY = 'listprice_user_data';
    
    // 保存用户数据到本地存储
    function saveUserData() {
      const userData = {
        costPrice: inCost.value,
        targetMargin: (document.querySelector('input[name="targetM"]:checked') || {}).value || '0.05'
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(userData));
      } catch (e) {
        console.warn('本地存储失败:', e);
      }
    }
    
    // 从本地存储恢复用户数据
    function restoreUserData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const userData = JSON.parse(saved);
          
          // 恢复进货价
          if (userData.costPrice && userData.costPrice.trim()) {
            inCost.value = userData.costPrice;
          }
          
          // 不恢复品类，避免误算；默认保持未选择
          
          // 恢复目标利润率
          if (userData.targetMargin) {
            const targetRadio = document.querySelector(`input[name="targetM"][value="${userData.targetMargin}"]`);
            if (targetRadio) {
              targetRadio.checked = true;
            }
          }
          
          console.log('已从本地存储恢复用户数据');
        }
      } catch (e) {
        console.warn('恢复本地存储数据失败:', e);
      }
    }
    
    // 清除本地存储数据
    function clearUserData() {
      try {
        localStorage.removeItem(STORAGE_KEY);
        // 重置表单到默认值
        inCost.value = '';
        selCate.value = '';
        document.querySelector('input[name="targetM"][value="0.05"]').checked = true;
        console.log('已清除本地存储数据');
        recalc(); // 重新计算
      } catch (e) {
        console.warn('清除本地存储数据失败:', e);
      }
    }
    
    // 事件绑定
    [inCost, selCate, ...document.querySelectorAll('input[name="targetM"]')].forEach(el=>{
      el.addEventListener('input', recalc);
      el.addEventListener('change', recalc);
      if (el.tagName === 'INPUT') el.addEventListener('focus', ()=> el.select());
      
      // 添加本地存储事件
      el.addEventListener('change', saveUserData);
      if (el.tagName === 'INPUT') {
        el.addEventListener('blur', saveUserData); // 失去焦点时保存
      }
    });
    
    // 进货价变化时特别处理内裤类目的广告占比调整
    inCost.addEventListener('input', function() {
      const currentCate = selCate.value;
      if (currentCate && currentCate.startsWith('内裤|')) {
        // 重新解析类目信息（会根据进货价调整广告占比）
        recalc();
      }
    });
    
    // 为新的清除按钮添加事件监听器
    document.getElementById('clearBtn').addEventListener('click', clearUserData);

    // 页面初始化
    function initPage() {
      restoreUserData(); // 恢复用户数据
      recalc();         // 初次计算
    }

    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPage);
    } else {
      initPage();
    }
  </script>
</body>
</html>
