<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åˆ°æ‰‹ä»·ä¸æ ‡ä»·å»ºè®®ï½œä¿æœ¬å¼•æ“</title>
  <style>
    :root{
      --bg:#F5F5F7; --card:#FFFFFF; --ink:#111111; --muted:#6e6e73; --accent:#007aff;
      --ok:#34c759; --warn:#ff9f0a; --bad:#ff3b30; --radius:14px;
      --sans:-apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      --mono:-apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:var(--sans)}
    header{padding:20px}
    h1{margin:0; font-size:22px}
    .sub{color:var(--muted); font-size:13px; margin-top:6px}
    main{padding:20px; display:grid; gap:16px}

    /* ä¸¤æ ï¼šå·¦è¾“å…¥ã€å³ç»“æœ */
    .wrap{display:grid; grid-template-columns: 45% 54%; gap:16px; align-items:stretch}
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } }

    .card{background:var(--card); border:1px solid #d2d2d7; border-radius:var(--radius); box-shadow:0 1px 2px rgba(0,0,0,.06); display:flex; flex-direction:column; height:100%}
    .card h2{margin:0; font-size:18px; padding:14px 14px; border-bottom:1px solid #e5e5ea; background:linear-gradient(180deg,#fafafa,#fff)}
    .content{padding:14px; flex:1; display:block}

    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px 2px}
    input, select{width:100%; background:#fff; border:1px solid #d2d2d7; border-radius:12px; padding:12px 10px; font-size:22px; font-weight:700; outline:none}
    input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,122,255,.18)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid-3565{grid-template-columns:35% 64%}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }

    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#eef2f7; border:1px solid #cfd3da; font-size:12px; font-weight:600; color:#0f172a; letter-spacing:.2px}

    /* ç»“æœå¤§å­— */
    .big{display:block; width:100%; text-align:center; padding:18px 14px; border-radius:14px; box-sizing:border-box}
    .big-input{width:100%; background:linear-gradient(180deg,#fafafa,#fff); border:1px solid #e5e5ea; border-radius:14px; padding:18px 16px; font-size:46px; font-weight:800; text-align:center; outline:none}
    .big-input.primary{--base:40px; font-size:var(--base); border-color:#d0e3ff; box-shadow:0 0 0 3px rgba(0,122,255,.10)}
    .big-input.secondary{font-size:35px}
    .big-input.tertiary{font-size:40px}
    .big-input[readonly]{background:linear-gradient(180deg,#fafafa,#fff)}
    .big-input.asdiv{display:flex; align-items:baseline; justify-content:center; gap:10px}
    .big-input .minor{font-weight:700; color:#444; font-size:calc(var(--base, 46px) - 8px)}
    .big-input .prefix,.big-input .suffix{font-weight:700; color:#333; font-size:calc(var(--base, 40px) - 10px)}
    .big-input.primary .amount{
      background: linear-gradient(180deg,#0062cc,#007aff);
      color: #ffffff;
      border-radius: 12px;
      padding: 0 8px;
      box-shadow: 0 0 0 1px rgba(255,255,255,.15);
    }
    .big-input .amount{font-size:calc(var(--base, 40px) + 6px); font-weight:900; color:#111; letter-spacing:.5px}
    .big.hint{font-size:13px; color:var(--muted); padding:0; margin-top:6px; display:none}
    .muted{color:var(--muted)}
    .step{font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.2px}

    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    .kpi .item{border:1px solid #e5e5ea; border-radius:12px; background:#fff; padding:10px}
    .kpi .lab{font-size:12px; color:var(--muted)}
    .kpi .val{margin-top:4px; font-size:18px; font-weight:500; font-family:var(--mono);color: #444444;}

    .note{font-size:12px; color:var(--muted)}
    
    /* ä½è°ƒçš„æ¸…é™¤æŒ‰é’®æ ·å¼ */
    .clear-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .clear-btn:hover {
      background: rgba(0,0,0,0.05);
      color: var(--bad);
    }

    /* ===== ç›®æ ‡åˆ©æ¶¦ç‡é€‰æ‹©å™¨æ ·å¼ ===== */
    .margin-selector {
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      border: 2px solid #e1e5f2;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 20px rgba(0, 122, 255, 0.08);
    }
    
    .margin-label {
      display: block;
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 16px;
      text-align: center;
      letter-spacing: 0.5px;
    }
    
    .margin-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .margin-option {
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .margin-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .option-content {
      background: #ffffff;
      border: 2px solid #e5e5ea;
      border-radius: 14px;
      padding: 20px 16px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .margin-option input[type="radio"]:checked + .option-content {
      border-color: var(--accent);
      background: linear-gradient(135deg, #f0f7ff 0%, #ffffff 100%);
      box-shadow: 0 4px 20px rgba(0, 122, 255, 0.15);
      transform: translateY(-2px);
    }
    
    .margin-option:hover .option-content {
      border-color: #007aff;
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.1);
    }
    
    .option-value {
      font-size: 38px;
      font-weight: 900;
      color: var(--accent);
      margin-bottom: 8px;
      letter-spacing: 1px;
    }
    
    .option-desc {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }
    
    .margin-option input[type="radio"]:checked + .option-content .option-value {
      color: var(--accent);
    }
    
    .margin-option input[type="radio"]:checked + .option-content .option-desc {
      color: #007aff;
      font-weight: 600;
    }

    /* iPad é€‚é… */
    @media (max-width: 1100px){
      input, select{font-size:20px}
    }
    /* æ‰‹æœºç«¯ä¼˜åŒ–ï¼ˆ<=740pxï¼‰ */
    @media (max-width: 740px){
      header{padding:16px}
      h1{font-size:18px}
      .sub{font-size:12px}
      main{padding:16px; gap:12px}
      .wrap{gap:12px}
      label{font-size:11px}
      input, select{font-size:16px; padding:10px 9px}
      .big-input{font-size:22px; padding:14px 12px}
      .big-input.primary{--base:30px}
      .big-input.secondary{font-size:26px}
      .big-input.tertiary{font-size:24px}
      .big-input .prefix,.big-input .suffix{font-size:calc(var(--base, 30px) - 10px)}
      .big-input .amount{font-size:calc(var(--base, 30px) + 6px)}
      .big-input .minor{font-size:calc(var(--base, 30px) - 8px)}
      
      /* æ‰‹æœºç«¯åˆ°æ‰‹ä»·è¾“å…¥æ¡†å¤šè¡Œå¸ƒå±€ */
      .big-input.asdiv {
        flex-direction: column;
        align-items: center;
        gap: 5px;
        padding: 10px;
      }
      .big-input .prefix {
        display: block;
        white-space: nowrap;
        font-size: 15px;
        font-weight: 600;
        margin-bottom: -2px;
      }
      .big-input .amount {
        display: block;
        font-size: 36px;
        line-height: 1.1;
        padding: 2px 12px;
      }
      .big-input .suffix {
        display: block;
        white-space: nowrap;
        font-size: 15px;
        font-weight: 600;
        margin-top: -2px;
      }
      .big-input .minor {
        display: block;
        font-size: 12px;
        margin-top: 2px;
      }

      /* ç§»åŠ¨ç«¯åˆ©æ¶¦ç‡é€‰æ‹©å™¨é€‚é… - ä¿æŒä¸¤åˆ—å¸ƒå±€ */
      .margin-selector { padding: 14px; margin: 12px 0 }
      /* ç§»é™¤å•åˆ—è®¾ç½®ï¼Œä¿æŒä¸¤åˆ—å¸ƒå±€ */
      /* .margin-options { grid-template-columns: 1fr; gap: 10px } */
      .option-content { padding: 10px 8px }
      .option-value { font-size: 24px }
      .margin-label { font-size: 14px; margin-bottom: 10px }

      /* ç³»ç»Ÿå‚æ•°ä¿æŒä¸€è¡Œ4åˆ—å¸ƒå±€ï¼ˆæŒ‰éœ€æ±‚ï¼‰ */
      .kpi { grid-template-columns: repeat(4, 1fr); gap: 8px }
      .kpi .item { padding: 8px 6px }
      .kpi .lab { font-size: 11px; line-height: 1.2 }
      .kpi .val { font-size: 13px; margin-top: 2px }
    }
  </style>
</head>
<body>
  <header>
    <h1>æ’æºç¥¥å”®ä»·è®¡ç®—ï¼ˆç¨åŠ¡åˆè§„ç‰ˆï¼‰</h1>
    <div class="sub">å·²çŸ¥æˆæœ¬ä¸ç³»ç»Ÿå‚æ•° â†’ æ¨ç®—åˆç†åˆ°æ‰‹ä»· â†’ å»ºè®®ä»·ï¼ˆ.8 ç»“å°¾ï¼‰â†’ é¡µé¢æ ‡ä»·ï¼ˆé»˜è®¤ç«‹å‡10%ï¼‰</div>
  </header>

  <main>
    <div class="wrap">
      <!-- å·¦ï¼šè¾“å…¥ä¸å›ºå®šå‚æ•°å±•ç¤º -->
      <section class="card">
        <h2>å‚æ•°ä¸è¾“å…¥ <button class="clear-btn" id="clearBtn" title="æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„è¾“å…¥æ•°æ®">æ¢å¤é»˜è®¤</button></h2>
        <div class="content">
          <div class="grid grid-3565">
            <div>
              <label>èšæ°´æ½­è¿›è´§ä»·ï¼ˆä¸å«ç¨ï¼ŒÂ¥ï¼‰</label>
              <input id="costPrice" type="text" placeholder="35.00" inputmode="decimal" pattern="^\d+(\.\d{1,2})?$" autocomplete="off" />
            </div>
            <div>
              <label>äº§å“å“ç±»ï¼ˆé¢„ä¼°é€€è´§ç‡ä¸å¹¿å‘Šå æ¯”ï¼‰</label>
              <select id="cate">
                <option value="" selected>è¯·é€‰æ‹©å“ç±»</option>
                <option value="å†…è£¤|0.06|0.30">å†…è£¤ï¼ˆé€€è´§ç‡ 6%ï¼‰</option>
                <option value="è–„å†…è¡£|0.12|0.22">è–„å†…è¡£ï¼ˆé€€è´§ç‡é¢„ä¼° 12%ï¼‰</option>
                <option value="å¤¹æ£‰ç©ºæ°”å±‚|0.25|0.23">å¤¹æ£‰ç©ºæ°”å±‚ï¼ˆé€€è´§ç‡é¢„ä¼° 25%ï¼‰</option>
                <option value="åŠ ç»’å†…è¡£|0.18|0.20">åŠ ç»’å†…è¡£ï¼ˆé€€è´§ç‡é¢„ä¼° 20%ï¼‰</option>
                <option value="å®¶å±…æœ|0.22|0.15">å®¶å±…æœï¼ˆé€€è´§ç‡é¢„ä¼° 20%ï¼‰</option>
                <option value="æ ¡æœç¥å™¨|0.20|0.20">æ ¡æœç¥å™¨ï¼ˆé€€è´§ç‡é¢„ä¼° 20%ï¼‰</option>
                <option value="è–„é©¬ç”²|0.15|0.18">è–„é©¬ç”²ï¼ˆé€€è´§ç‡é¢„ä¼° 15%ï¼‰</option>
                <option value="ç¾Šæ¯›è¡«|0.22|0.08">ç¾Šæ¯›è¡«ï¼ˆé€€è´§ç‡é¢„ä¼° 22%ï¼‰</option>
              </select>
            </div>
          </div>

          <div class="margin-selector" style="margin-top:16px">
            <label class="margin-label">ğŸ¯ ç›®æ ‡åˆ©æ¶¦ç‡</label>
            <div class="margin-options">
              <label class="margin-option">
                <input type="radio" name="targetM" value="0.05" checked />
                <div class="option-content">
                  <div class="option-value">5%</div>
                  <div class="option-desc">ä¿å®ˆç­–ç•¥</div>
                </div>
              </label>
              <label class="margin-option">
                <input type="radio" name="targetM" value="0.08" />
                <div class="option-content">
                  <div class="option-value">8%</div>
                  <div class="option-desc">å¹³è¡¡ç­–ç•¥</div>
                </div>
              </label>
            </div>
          </div>

          <div class="block" style="margin-top:12px">
            <div class="note">ç³»ç»Ÿé»˜è®¤å‚æ•° | å‡ä»¥å«ç¨ä»·ä¸ºå£å¾„ï¼ˆä¸å¯ä¿®æ”¹ï¼Œç”¨äºå‚ä¸è®¡ç®—ï¼‰ï¼š</div>
            <div class="kpi" style="margin-top:8px">
              <div class="item"><div class="lab">é”€é¡¹ç¨ç‡</div><div class="val" id="k_sales">13%</div></div>
              <div class="item"><div class="lab">å•†å“è¿›é¡¹ç¨ç‡</div><div class="val" id="k_output">13%</div></div>
              <div class="item"><div class="lab">å¼€ç¥¨æˆæœ¬æ¯”ä¾‹</div><div class="val" id="k_input">6%</div></div>
              <div class="item"><div class="lab">æœåŠ¡è´¹ç¨ç‡ï¼ˆä½£é‡‘/å¹¿å‘Šï¼‰</div><div class="val" id="k_svat">6%</div></div>
              <div class="item"><div class="lab">å¹³å°ä½£é‡‘ç‡</div><div class="val" id="k_comm">5.5%</div></div>
              <div class="item"><div class="lab">ç‰©æµè´¹</div><div class="val" id="k_ship">Â¥2.80</div></div>
              <div class="item"><div class="lab">è¿è´¹é™©</div><div class="val" id="k_ins">Â¥1.50</div></div>
              <div class="item"><div class="lab">å…¶ä»–æˆæœ¬</div><div class="val" id="k_other">Â¥2.50</div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- å³ï¼šè®¡ç®—ç»“æœ -->
      <section class="card">
        <h2>ç»“æœä¸å»ºè®®ï¼ˆä»·æ ¼å·²åŒ…å«å¹¿å‘Šè´¹é¢„ç®—ï¼‰</h2>
        <div class="content">
          <!-- 1. æ¨ç®—åˆ°æ‰‹ä»·ï¼ˆæ¥æºï¼‰ -->
          <div>
            <label>åˆ°æ‰‹ä»·</label>
            <div id="outPriceInput" class="big-input tertiary asdiv">
              <span class="prefix">æ¨ç®—åˆ°æ‰‹ä»·</span>
              <span id="outAmount" class="amount">â€”</span>
              <span class="suffix">å…ƒå¯è¾¾ç›®æ ‡</span>
              <span id="outMinor" class="minor"></span>
            </div>
          </div>

          <!-- 2. å»ºè®®åˆ°æ‰‹ä»·ï¼ˆä¸»ç»“è®ºï¼‰ -->
          <div style="margin-top:14px">
            <label>å»ºè®®åˆ°æ‰‹ä»·</label>
            <div id="sugPriceInput" class="big-input primary asdiv">
              <span class="prefix">å»ºè®®åˆ°æ‰‹ä»·</span>
              <span id="sugAmount" class="amount">â€”</span>
              <span class="suffix">å…ƒ</span>
              <span id="sugMinor" class="minor"></span>
            </div>
          </div>

          <!-- 3. é¡µé¢æ ‡ä»·ï¼ˆåŸºäºä¼˜æƒ åè§£ï¼‰ -->
          <div style="margin-top:14px">
            <label>é¡µé¢æ ‡ä»·ï¼ˆåº—é“ºä¼˜æƒ ç«‹å‡10%ï¼‰</label>
            <div id="listPriceInput" class="big-input secondary asdiv">
              <span class="prefix">é¡µé¢æ ‡ä»·</span>
              <span id="listAmount" class="amount">â€”</span>
              <span class="suffix">å…ƒï¼ˆç«‹å‡10%ï¼‰</span>
              <span id="listMinor" class="minor"></span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ===== è®¡ç®—å‡½æ•°ï¼ˆä» engine.js ç²¾ç®€å†…è”ï¼Œæ”¯æŒç¦»çº¿ç‹¬ç«‹è¿è¡Œï¼‰ =====
    function profitGivenAdRateAndR(p, adRate, r, basis) {
      const Rev = p.sellingPrice * r;
      const goodsCost = p.costPrice * (1 + p.inputTaxRate) * (p.goodsMode === 'canReturn' ? r : 1);
      const othersCost = p.shippingCost + p.shippingInsurance + p.otherCost;
      const commission = p.sellingPrice * p.platformRate * r;

      const VAT_out = Rev / (1 + p.salesTaxRate) * p.salesTaxRate;
      const VAT_in_goods = p.costPrice * p.outputTaxRate * (p.goodsMode === 'canReturn' ? r : 1);
      const VAT_in_comm = commission / (1 + p.serviceVATRate) * p.serviceVATRate;

      const base = (basis === 'gmv') ? p.sellingPrice : Rev;
      const adCostGiven = base * adRate;
      const VAT_in_ad_given = adCostGiven / (1 + p.serviceVATRate) * p.serviceVATRate;

      const profit = Rev - (goodsCost + othersCost + commission + adCostGiven)
        - (VAT_out - VAT_in_goods - VAT_in_comm - VAT_in_ad_given);
      const margin = (Rev > 0) ? (profit / Rev) : NaN;
      return { profit, margin, adCostGiven };
    }

    function solveSellingPrice(p, r, a, basis, m) {
      const G = p.costPrice * (1 + p.inputTaxRate) * (p.goodsMode === 'canReturn' ? r : 1);
      const O = p.shippingCost + p.shippingInsurance + p.otherCost;
      const Vg = p.costPrice * p.outputTaxRate * (p.goodsMode === 'canReturn' ? r : 1);
      const t = p.salesTaxRate;
      const s = p.serviceVATRate;
      const pr = p.platformRate;

      const numerator = (Vg - G - O);
      let denom;

      if (basis === 'effective') {
        // S = (Vg - G - O) / [ r * ( m - 1 + t/(1+t) + (a+pr)/(1+s) ) ]
        denom = r * (m - 1 + (t/(1+t)) + ((a + pr) / (1 + s)));
      } else {
        // S = (Vg - G - O) / [ r * ( m - 1 + t/(1+t) + pr/(1+s) ) + a/(1+s) ]
        denom = r * (m - 1 + (t/(1+t)) + (pr / (1 + s))) + (a / (1 + s));
      }
      if (!isFinite(numerator) || !isFinite(denom) || Math.abs(denom) < 1e-9) return NaN;
      const S = numerator / denom;
      return S > 0 && isFinite(S) ? S : NaN;
    }

    // ===== æ ‡ä»·è®¡ç®—ï¼ˆåˆ°æ‰‹ä»· â†” æ ‡ä»·ï¼‰è¾…åŠ© =====
    function yuanToWu(y){
      const s = String(y ?? '').trim();
      if (!s) return 0;
      const m = s.match(/^(-?)(\d+)(?:\.(\d{0,}))?$/);
      if (!m) return Math.round(Number(s) * 10000);
      const sign = m[1] === '-' ? -1 : 1;
      const int = m[2];
      const dec = (m[3] || '').padEnd(4, '0').slice(0, 4);
      return sign * (parseInt(int, 10) * 10000 + parseInt(dec || '0', 10));
    }
    function listPriceForwardNetCents(listPriceCents, discountPct, tiers){
      const priceWu = Math.floor(Number(listPriceCents) * 100);
      const factor = Math.round((1 - Number(discountPct || 0)) * 10000);
      let afterWu = Math.floor(priceWu * factor / 10000);
      let offWu = 0;
      if (Array.isArray(tiers)){
        for (const t of tiers){
          const thrWu = yuanToWu(t?.threshold ?? '0');
          const offTWu = yuanToWu(t?.off ?? '0');
          if (afterWu >= thrWu) offWu = Math.max(offWu, offTWu);
        }
      }
      const netWu = Math.max(0, afterWu - offWu);
      return Math.floor(netWu / 100);
    }
    function listPriceForwardNetWu(listPriceCents, discountPct, tiers){
      const priceWu = Math.floor(Number(listPriceCents) * 100);
      const factor = Math.round((1 - Number(discountPct || 0)) * 10000);
      let afterWu = Math.floor(priceWu * factor / 10000);
      let offWu = 0;
      if (Array.isArray(tiers)){
        for (const t of tiers){
          const thrWu = yuanToWu(t?.threshold ?? '0');
          const offTWu = yuanToWu(t?.off ?? '0');
          if (afterWu >= thrWu) offWu = Math.max(offWu, offTWu);
        }
      }
      return Math.max(0, afterWu - offWu);
    }
    function solveListPriceCents(targetCents, discountPct, tiers){
      if (!(targetCents > 0)) return 0;
      let lo = targetCents;
      let hi = Math.max(targetCents + 1, targetCents * 2 + 1000);
      while (listPriceForwardNetCents(hi, discountPct, tiers) < targetCents){
        hi = Math.floor(hi * 1.5) + 1000;
        if (hi > 1e9) break;
      }
      while (lo < hi){
        const mid = Math.floor((lo + hi) >> 1);
        const net = listPriceForwardNetCents(mid, discountPct, tiers);
        if (net >= targetCents) hi = mid; else lo = mid + 1;
      }
      let price = lo;
      const targetWu = targetCents * 100;
      let netAfterWu = listPriceForwardNetWu(price, discountPct, tiers);
      while (price > 0 && netAfterWu > targetWu){
        price -= 1;
        netAfterWu = listPriceForwardNetWu(price, discountPct, tiers);
      }
      return price;
    }

    // å›ºå®šç³»ç»Ÿå‚æ•°ï¼ˆä¸å¯ç¼–è¾‘ï¼‰
    const SYSTEM = {
      salesTaxRate: 0.13,       // é”€é¡¹ç¨ç‡ 13%
      outputTaxRate: 0.13,      // å•†å“è¿›é¡¹ç¨ç‡ 13%
      inputTaxRate: 0.06,       // å¼€ç¥¨æˆæœ¬æ¯”ä¾‹ 6%
      serviceVATRate: 0.06,     // æœåŠ¡è´¹ç¨ç‡ï¼ˆä½£é‡‘/å¹¿å‘Šï¼‰6%
      platformRate: 0.055,      // å¹³å°ä½£é‡‘ç‡ 5.5%
      shippingCost: 2.8,
      shippingInsurance: 1.5,
      otherCost: 2.5,
      goodsMode: 'canReturn'
    };

    const $ = id => document.getElementById(id);
    const fmt2 = n => (isFinite(n) ? Number(n).toFixed(2) : 'â€”');
    const fmtPct = n => (isFinite(n) ? (n*100).toFixed(2) + '%' : 'â€”');

    const inCost = $('costPrice');
    const selCate = $('cate');
    const outPriceInput = $('outPriceInput');
    const outAmount = $('outAmount');
    const outMinor = $('outMinor');
    const sugPriceInput = $('sugPriceInput');
    const sugAmount = $('sugAmount');
    const sugMinor = $('sugMinor');
    const listPriceInput = $('listPriceInput');
    const listAmount = $('listAmount');
    const listMinor = $('listMinor');

    function parseCate(val){
      // æ ¼å¼ï¼š åç§°|é€€è´§ç‡|å¹¿å‘Šå æ¯”
      const parts = String(val || '').split('|');
      const name = parts[0] || '';
      const rr = parseFloat(parts[1] || '0') || 0; // å°æ•°
      let a = parseFloat(parts[2] || '0') || 0; // å°æ•°ï¼ˆå¹¿å‘Šå æ¯”æ•°å€¼ï¼‰
      
      // æ–°ç®—æ³•ï¼šé’ˆå¯¹å†…è£¤ç±»ç›®çš„å¹¿å‘Šå æ¯”åŠ¨æ€è°ƒæ•´
      // å½“å†…è£¤ç±»ç›®çš„è¿›è´§ä»·å°äº32.5å…ƒæ—¶ï¼Œå¹¿å‘Šå æ¯”æŒ‰30%é¢„ä¼°
      // å½“è¿›è´§ä»·å¤§äºç­‰äº32.5å…ƒæ—¶ï¼Œå¹¿å‘Šå æ¯”æŒ‰25%é¢„ä¼°
      const costPrice = parseFloat(inCost.value) || 0;
      if (name === 'å†…è£¤') {
        if (costPrice >= 32.5) {
          a = 0.25; // è¿›è´§ä»·>=32.5å…ƒæ—¶ï¼Œå†…è£¤å¹¿å‘Šå æ¯”ä¸º25%
        }
        // å°äº32.5å…ƒæ—¶ä¿æŒåŸæœ‰çš„30%ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
      }
      
      return { name, returnRate: rr, adRate: a };
    }

    function toCents(x){ return Math.round(Number(x || 0) * 100); }
    function fromCents(c){ return Number(c || 0) / 100; }

    function roundUpTo_5_8_9_8(x){
      // è§„åˆ™ï¼šå‘ä¸Šå–åˆ°ä»¥ .8 ç»“å°¾çš„ 5 æˆ– 9 ä½ï¼Œå¦‚ 65.8ã€69.8
      // æ–°è§„åˆ™ï¼šå¦‚æœæ¨ç®—çš„åˆ°æ‰‹ä»·ä¾¿å®œ1å…ƒä»¥å†…æœ‰æœ€ä½³å”®ä»·ï¼Œåˆ™å¯ä»¥é€‰æ‹©å¾€ä¸‹ä¸€æ¡£çš„å”®ä»·
      const base10 = Math.floor(x / 10) * 10;
      const c58 = base10 + 5.8;
      const c98 = base10 + 9.8;
      const prevBase98 = base10 - 10 + 9.8; // ä¸Šä¸€æ¡£çš„9.8
      const prevBase58 = base10 - 10 + 5.8; // ä¸Šä¸€æ¡£çš„5.8
      const nextBase58 = base10 + 10 + 5.8;
      
      // å¦‚æœä»·æ ¼åˆšå¥½æ¯”æŸä¸ªæ¡£ä½é«˜ä¸€ç‚¹ç‚¹ï¼ˆä¸è¶…è¿‡1å…ƒï¼‰ï¼Œåˆ™é€‰æ‹©å¾€ä¸‹ä¸€æ¡£
      if (x > c58 && x <= c58 + 1) return c58;
      if (x > c98 && x <= c98 + 1) return c98;
      
      // æ–°å¢ï¼šå¦‚æœä»·æ ¼æ¯”æŸä¸ªæ¡£ä½ä½ä¸€ç‚¹ç‚¹ï¼ˆä¸è¶…è¿‡1å…ƒï¼‰ï¼Œåˆ™é€‰æ‹©å¾€ä¸Šä¸€æ¡£
      if (x < c58 && x >= c58 - 1) return c58;
      if (x < c98 && x >= c98 - 1) return c98;
      
      // æ£€æŸ¥ä¸Šä¸€æ¡£çš„ä»·æ ¼ï¼Œä½†å¿…é¡»åœ¨1å…ƒèŒƒå›´å†…
      if (x >= prevBase98 && x <= prevBase98 + 1 && prevBase98 > 0) return prevBase98;
      if (x >= prevBase58 && x <= prevBase58 + 1 && prevBase58 > 0) return prevBase58;
      
      // åŸæœ‰é€»è¾‘ï¼šé€‰æ‹©åˆé€‚çš„æ¡£ä½
      if (x <= c58) return c58;
      if (x <= c98) return c98;
      return nextBase58; // ä¸‹ä¸€æ¡£ 5.8
    }

    function recalc(){
      const cost = parseFloat(inCost.value);
      const cateVal = (selCate.value || '').trim();
      if (!cateVal){
        if (outAmount) outAmount.textContent = 'â€”';
        if (outMinor) outMinor.textContent = '';
        if (sugAmount) sugAmount.textContent = 'â€”';
        if (sugMinor) sugMinor.textContent = 'ï¼ˆè¯·å…ˆé€‰æ‹©å“ç±»å†è®¡ç®—ï¼‰';
        if (listAmount) listAmount.textContent = 'â€”';
        if (listMinor) listMinor.textContent = '';
        return;
      }
      const cate = parseCate(cateVal);
      const targetM = parseFloat((document.querySelector('input[name="targetM"]:checked')||{}).value || '0.08');

      if (!(cost > 0)){
        if (outAmount) outAmount.textContent = 'â€”';
        if (outMinor) outMinor.textContent = '';
        if (sugAmount) sugAmount.textContent = 'â€”';
        if (sugMinor) sugMinor.textContent = '';
        if (listAmount) listAmount.textContent = 'â€”';
        if (listMinor) listMinor.textContent = '';
        return;
      }

      const r = Math.max(0, 1 - cate.returnRate);

      // æ„é€ å‚æ•°ï¼šå”®ä»·æœªçŸ¥ï¼Œä»…ç”¨äºå…¬å¼ä¸­çš„æˆæœ¬é¡¹
      const baseParams = {
        sellingPrice: 0, // solveSellingPrice ä¸ä¾èµ–è¯¥å€¼
        returnRate: cate.returnRate,
        costPrice: cost,
        inputTaxRate: SYSTEM.inputTaxRate,
        outputTaxRate: SYSTEM.outputTaxRate,
        platformRate: SYSTEM.platformRate,
        shippingCost: SYSTEM.shippingCost,
        shippingInsurance: SYSTEM.shippingInsurance,
        otherCost: SYSTEM.otherCost,
        salesTaxRate: SYSTEM.salesTaxRate,
        serviceVATRate: SYSTEM.serviceVATRate,
        goodsMode: SYSTEM.goodsMode
      };

      // åˆ°æ‰‹ä»·ï¼šæŒ‰å¹¿å‘Šå æ¯”ï¼ˆæœ‰æ•ˆè¥æ”¶å£å¾„ï¼‰ä¸ç›®æ ‡åˆ©æ¶¦ç‡åè§£
      const S = solveSellingPrice(baseParams, r, cate.adRate, 'effective', targetM);
      if (outAmount) outAmount.textContent = isFinite(S)&&S>0?fmt2(S):'â€”';
      if (outMinor) outMinor.textContent = '';

      // å»ºè®®åˆ°æ‰‹ä»·ï¼šå‘ä¸Šå–åˆ° *.8ï¼ˆä¼˜å…ˆ 9.8ï¼Œå…¶æ¬¡ 5.8ï¼‰
      let S_sug = isFinite(S) && S>0 ? roundUpTo_5_8_9_8(S) : NaN;
      if (!isFinite(S_sug)){
        if (sugAmount) sugAmount.textContent = 'â€”';
        if (sugMinor) sugMinor.textContent = '';
      } else {
        // è®¡ç®—å»ºè®®ä»·å¯¹åº”çš„åˆ©æ¶¦ç‡
        const paramsForMargin = { ...baseParams, sellingPrice: S_sug };
        const { margin } = profitGivenAdRateAndR(paramsForMargin, cate.adRate, r, 'effective');
        if (sugAmount) sugAmount.textContent = `${fmt2(S_sug)}`;
        if (sugMinor) sugMinor.textContent = `ï¼ˆåˆ©æ¶¦ç‡çº¦ ${fmtPct(margin)}ï¼‰`;
      }

      // é¡µé¢æ ‡ä»·ï¼šé»˜è®¤ç«‹å‡10%ã€æ— æ»¡å‡
      if (isFinite(S_sug)){
        const targetCents = toCents(S_sug);
        const listCents = solveListPriceCents(targetCents, 0.10, []);
        const listY = fromCents(listCents);
        const checkNet = fromCents(listPriceForwardNetCents(listCents, 0.10, []));
        if (listAmount) listAmount.textContent = fmt2(listY);
        if (listMinor) listMinor.textContent = '';
      } else {
        if (listAmount) listAmount.textContent = 'â€”';
        if (listMinor) listMinor.textContent = '';
      }
    }

    // ===== æœ¬åœ°å­˜å‚¨åŠŸèƒ½ =====
    const STORAGE_KEY = 'listprice_user_data';
    
    // ä¿å­˜ç”¨æˆ·æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    function saveUserData() {
      const userData = {
        costPrice: inCost.value,
        targetMargin: (document.querySelector('input[name="targetM"]:checked') || {}).value || '0.05'
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(userData));
      } catch (e) {
        console.warn('æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
      }
    }
    
    // ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç”¨æˆ·æ•°æ®
    function restoreUserData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const userData = JSON.parse(saved);
          
          // æ¢å¤è¿›è´§ä»·
          if (userData.costPrice && userData.costPrice.trim()) {
            inCost.value = userData.costPrice;
          }
          
          // ä¸æ¢å¤å“ç±»ï¼Œé¿å…è¯¯ç®—ï¼›é»˜è®¤ä¿æŒæœªé€‰æ‹©
          
          // æ¢å¤ç›®æ ‡åˆ©æ¶¦ç‡
          if (userData.targetMargin) {
            const targetRadio = document.querySelector(`input[name="targetM"][value="${userData.targetMargin}"]`);
            if (targetRadio) {
              targetRadio.checked = true;
            }
          }
          
          console.log('å·²ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç”¨æˆ·æ•°æ®');
        }
      } catch (e) {
        console.warn('æ¢å¤æœ¬åœ°å­˜å‚¨æ•°æ®å¤±è´¥:', e);
      }
    }
    
    // æ¸…é™¤æœ¬åœ°å­˜å‚¨æ•°æ®
    function clearUserData() {
      try {
        localStorage.removeItem(STORAGE_KEY);
        // é‡ç½®è¡¨å•åˆ°é»˜è®¤å€¼
        inCost.value = '';
        selCate.value = '';
        document.querySelector('input[name="targetM"][value="0.05"]').checked = true;
        console.log('å·²æ¸…é™¤æœ¬åœ°å­˜å‚¨æ•°æ®');
        recalc(); // é‡æ–°è®¡ç®—
      } catch (e) {
        console.warn('æ¸…é™¤æœ¬åœ°å­˜å‚¨æ•°æ®å¤±è´¥:', e);
      }
    }
    
    // äº‹ä»¶ç»‘å®š
    [inCost, selCate, ...document.querySelectorAll('input[name="targetM"]')].forEach(el=>{
      el.addEventListener('input', recalc);
      el.addEventListener('change', recalc);
      if (el.tagName === 'INPUT') el.addEventListener('focus', ()=> el.select());
      
      // æ·»åŠ æœ¬åœ°å­˜å‚¨äº‹ä»¶
      el.addEventListener('change', saveUserData);
      if (el.tagName === 'INPUT') {
        el.addEventListener('blur', saveUserData); // å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
      }
    });
    
    // è¿›è´§ä»·å˜åŒ–æ—¶ç‰¹åˆ«å¤„ç†å†…è£¤ç±»ç›®çš„å¹¿å‘Šå æ¯”è°ƒæ•´
    inCost.addEventListener('input', function() {
      const currentCate = selCate.value;
      if (currentCate && currentCate.startsWith('å†…è£¤|')) {
        // é‡æ–°è§£æç±»ç›®ä¿¡æ¯ï¼ˆä¼šæ ¹æ®è¿›è´§ä»·è°ƒæ•´å¹¿å‘Šå æ¯”ï¼‰
        recalc();
      }
    });
    
    // ä¸ºæ–°çš„æ¸…é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('clearBtn').addEventListener('click', clearUserData);

    // é¡µé¢åˆå§‹åŒ–
    function initPage() {
      restoreUserData(); // æ¢å¤ç”¨æˆ·æ•°æ®
      recalc();         // åˆæ¬¡è®¡ç®—
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPage);
    } else {
      initPage();
    }
  </script>
</body>
</html>
